name: Sync API Types to Frontend

on:
  push:
    branches:
      - main  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®mainãƒ–ãƒ©ãƒ³ãƒã«Pushã•ã‚ŒãŸæ™‚ã«å‹•ã
    paths:
      - 'api-documents/api.yaml'  # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã ã‘å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

jobs:
  sync-types:
    runs-on: ubuntu-latest
    steps:
      # 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Backend Repository
        uses: actions/checkout@v4

      # 2. Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. æŒ‡å®šã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã§å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
      - name: Generate TypeScript Types
        run: npx openapi-typescript ./api-documents/api.yaml -o ./api-documents/schema.d.ts

      # 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã€Œfrontend-repoã€ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Frontend Repository
        uses: actions/checkout@v4
        with:
          repository: 'sunshine-724/my-homepage'
          token: ${{ secrets.FRONTEND_SYNC_PAT }}
          path: 'frontend-repo'
          ref: 'dev'

      # 5. ç”Ÿæˆã—ãŸschema.d.tsã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã«ã‚³ãƒ”ãƒ¼
      - name: Copy generated types to Frontend
        run: |
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®é…ç½®å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p ./frontend-repo/src/types/payload
          cp ./api-documents/schema.d.ts ./frontend-repo/src/types/payload/schema.d.ts

      # 6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªã«å¤‰æ›´ãŒã‚ã‚Œã°PRã‚’ä½œæˆ
      - name: Create Pull Request in Frontend Repo
        env:
          GH_TOKEN: ${{ secrets.FRONTEND_SYNC_PAT }}
        run: |
          cd frontend-repo
          
          # Gitã®ã‚³ãƒŸãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’GitHub Actionsã®Botã«è¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å·®åˆ†ãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -n "$(git status --porcelain)" ]; then
            # ä¸€æ„ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’ä½œæˆ
            BRANCH_NAME="update-api-types-$(date +%s)"
            git checkout -b $BRANCH_NAME
            
            # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦Push
            git add src/types/payload/schema.d.ts
            git commit -m "chore: APIä»•æ§˜å¤‰æ›´ã«ä¼´ã†å‹å®šç¾©ã®è‡ªå‹•åŒæœŸ"
            git push origin $BRANCH_NAME

            # GitHub CLIã‚’ä½¿ã£ã¦Pull Requestã‚’ä½œæˆ
            gh pr create \
              --title "ğŸš€ APIã‚¹ã‚­ãƒ¼ãƒã®æ›´æ–°ã«ä¼´ã†å‹å®šç¾©ã®è‡ªå‹•åŒæœŸ" \
              --body "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® \`api.yaml\` ãŒæ›´æ–°ã•ã‚ŒãŸãŸã‚ã€æœ€æ–°ã®å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚" \
              --base dev \
              --head $BRANCH_NAME
          else
            echo "å‹å®šç¾©ã«å¤‰æ›´ãŒãªã„ãŸã‚ã€PRã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
